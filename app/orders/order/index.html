<html>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>
    <script defer src="/static/js/navbar.js"></script>
</head>

<body>
    <div id='navbar'></div>
    <div class='container-fluid'>
        <h1 id='orderTitle'></h1>
        <h3 class='text-muted' id='vendor'></h3>
        <h3 class='text-muted' id='buyer'></h3>
        <h5 class='fst-italic' id='price'></h5>

        <div class='my-4' id='orderInfo'>
            <h2>Order Info</h2>
            <form id='metadata'></form>

            <div id='actions'>
                <h4>Actions</h4>
                <button class='btn btn-success' id='fulfillOrderButton'>Mark Order as Recieved</button>
                <button class='btn btn-danger' id='delOrderButton'>Cancel Order</button>
            </div>
        </div>
    </div>

</body>

<script type='module'>
    toastr.options = {
        "closeButton": false,
        "positionClass": "toast-bottom-center",
        "preventDuplicates": true
    }

    // Get order information

    let params = new URLSearchParams(window.location.search);
    let orderID = params.get("orderID");

    let res = await fetch(`/api/orders/order/?orderID=${orderID}`);
    let order = {};
    if (res.status === 200) {
        let json = await res.json();
        order = json;
    } else {
        let err = await res.text();
        if (res.status === 401 && err === "Session timed out. Please log in again.") {
                localStorage.clear();
                window.location = "/app/login/";
            }
        toastr.error(err, "Error");
    }

    $("#orderTitle").text(`Order ${order.info.order_id}`);
    $("#vendor").text(`Sold by ${order.item.vendor_name}`);
    $("#buyer").text(`Bought by ${order.info.username}`);
    $("#price").text(`Bought at $${order.item.price}`);



    let metadataBlock = "";
    if (order.metadata.length === 0) {
        metadataBlock = "No metadata!"
    } else {
        let canEditMeta = (localStorage.getItem("role") === "Vendor" || localStorage.getItem("role") === "Admin") ? false : true;
        for (let meta of order.metadata) {
            if (canEditMeta) {
                // person is user, allow them to change the fields and stuff
                if (order.info.fulfilled) {
                    metadataBlock += `<div class='mb-2'><label for='metadata[]' class='form-label'>${meta.metadata_name}:</label> <input id='${meta.metadata_id}'class = 'form-control' name=metadata[] disabled value='${meta.value}'></div>`
                } else {
                    metadataBlock += `<div class='mb-2'><label for='metadata[]' class='form-label'> ${meta.metadata_name}:</label> <input id='${meta.metadata_id}' class = 'form-control' name=metadata[] value='${meta.value}'></div>`
                }
                
            } else {
                metadataBlock += `<div class='mb-2'><label for='metadata[]' class='form-label'>${meta.metadata_name}:</label> <input id='${meta.metadata_id}'class = 'form-control' name=metadata[] disabled value='${meta.value}'></div>`
            }

        }

        if (canEditMeta && !order.info.fulfilled) {
            metadataBlock += "<button class='btn btn-primary' type='submit'>Update Metadata</button>"
        } else {
            if (order.info.fulfilled) {
                $("#actions").hide();
            } else {
                $("#fulfillOrderButton").hide();
            }
            
        }

    }

    $("#metadata").html(metadataBlock);


    $("#metadata").submit(async (e) => {
        e.preventDefault();
        let metadata = {};
        $("#metadata input").each((index, element) => {
            metadata[element.id] = $(element).val();
        });

        let metaJson = JSON.stringify(metadata);
        const formData = new FormData();
        formData.append("metadata", metaJson);
        let res = await fetch(`/api/orders/updateMeta/?orderID=${orderID}`,
            {
                body: formData,
                method: "PUT"
            })

        if (res.status === 200) {
            let text = await res.text();
            console.log(text);
            window.location = "/app/orders/"
        } else {
            let err = await res.text();
            if (res.status === 401 && err === "Session timed out. Please log in again.") {
                localStorage.clear();
                window.location = "/app/login/";
            }
            toastr.error(err, "Error");
        }
    })

    $("#delOrderButton").click(async (e) => {
        if (!confirm("Are you sure you want to cancel this order?")) {
            return;
        }

        let res = await fetch(`/api/orders/delete/?orderID=${orderID}`,
            {
                method: "DELETE"
            });

        if (res.status === 200) {
            let text = await res.text();
            window.location = "/app/orders/"
        } else {
            let err = await res.text();
            if (res.status === 401 && err === "Session timed out. Please log in again.") {
                localStorage.clear();
                window.location = "/app/login/";
            }
            toastr.error(err, "Error");
        }
    })

    $("#fulfillOrderButton").click(async (e) => {
        if (!confirm("Are you sure you want to mark this order as recieved?")) {
            return;
        }

        let res = await fetch(`/api/orders/fulfill/?orderID=${orderID}`,
            {
                method: "PUT"
            });

        if (res.status === 200) {
            let text = await res.text();
            console.log(text);
            window.location = "/app/orders/"
        } else {
            let err = await res.text();
            if (res.status === 401 && err === "Session timed out. Please log in again.") {
                localStorage.clear();
                window.location = "/app/login/";
            }
            toastr.error(err, "Error");
        }
    })
    console.log(order);
</script>