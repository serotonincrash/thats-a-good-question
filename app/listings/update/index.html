<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>
  <script defer src="/static/js/navbar.js"></script>
</head>

<body>
  <div id='navbar'></div>

  <div class='container-fluid'>
    <form id='updateListingForm' method="post">
      <h1>Product Update</h1>
      <h2>Product Name:</h2>
      <input type="text" id='itemName' name="item_name"><br><br>

      <h2>Description:</h2> <textarea id='description' name="description" rows="5" cols="40"></textarea><br><br>

      <h2>Materials Used:</h2>
      <button type="button" id='addMatButton' class='btn btn-primary'>Add Material</button><br>
      <div class='my-4' id='materialsUsed'>
      </div>

      <h2>Customisations:</h2>
      <button type="button" id='addCustButton' class='btn btn-primary'>Add Customisation</button>
      <br>
      <div class='my-4' id='customisations'>

      </div>

      <h2>Price:</h2>
      <input type="number" id='price' name="price">
      <br>
      <br>
      <input class='btn btn-primary' type="submit">
    </form>
  </div>
</body>

<script type='module'>
  toastr.options = {
    "closeButton": false,
    "positionClass": "toast-bottom-center",
    "preventDuplicates": true
  }



  // Get item information

  let params = new URLSearchParams(window.location.search);
  let itemID = params.get("itemID");

  if (!itemID) {
    toastr.error("There's no item ID to edit!", "Error");
  }

  let res = await fetch(`/api/listings/item/?item_id=${itemID}`);
  let info = {};
  if (res.status === 200) {
    info = await res.json();
    console.log(info);
  } else {
    let error = await res.text();
    toastr.error(error, "Error");
  }
  $("#itemName").val(info.info[0].name).change();
  $("#description").val(info.info[0].description).change();
  $("#price").val(info.info[0].price).change();

  // material handling

  let matIndex = 1;
  res = await fetch(`/api/inventory/`);
  let mats = {};
  if (res.status === 200) {
    mats = await res.json();
    console.log(mats);
  } else {
    let error = await res.text();
    toastr.error(error, "Error");
  }

  for (let chosenMaterial of info.materials) {

    for (let x of [...Array(chosenMaterial.amount).keys()]) {
      let id = `material${matIndex}`;
      let matSelect = `<div class='mt-2'><label class = 'me-2' for='materials[]'>Material ${matIndex}:</label><select id=${id}   name='materials[]'>`;
      for (let mat of mats) {
        matSelect += `<option value='${mat.part_id}'>${mat.part_name}</option>`
      }
      matSelect += `</select></div>`
      let matHTML = $.parseHTML(matSelect);
      $("#materialsUsed").append(matHTML);
      $("#" + id).val(chosenMaterial.part_id).change();
      matIndex += 1;
    }

  }

  // metadata handling 
  let custIndex = 1;
  for (let metadata of info.metadata) {
    let custSelect = `<div class='mt-2'><label class = 'me-2' for='metadata'>Customisation ${custIndex}</label><input name='metadata[]' value=${metadata.metadata_name} placeholder='Customisation name'></div>`
    let custHTML = $.parseHTML(custSelect);
    $("#customisations").append(custHTML);
    custIndex += 1;
  }




</script>