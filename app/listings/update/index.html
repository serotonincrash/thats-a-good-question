<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>
  <script defer src="/static/js/navbar.js"></script>
</head>

<body>
  <div id='navbar'></div>

  <div class='container-fluid'>
    <form id='updateListingForm' method="post">
      <h1>Product Update</h1>
      <h2>Product Name:</h2>
      <input type="text" required id='itemName' name="item_name"><br><br>

      <h2>Description:</h2> <textarea required id='description' name="description" rows="5" cols="40"></textarea><br><br>

      <h2>Materials Used:</h2>
      <button type="button" id='addMatButton' class='btn btn-primary'>Add Material</button><br>
      <div class='my-4' id='materialsUsed'>
      </div>

      <h2>Customisations:</h2>
      <button type="button" id='addCustButton' class='btn btn-primary'>Add Customisation</button>
      <br>
      <div class='my-4' id='customisations'>

      </div>

      <h2>Price:</h2>
      <input type="number" id='price' name="price">
      <br>
      <br>
      <input class='btn btn-primary' type="submit">
    </form>
  </div>
</body>

<script type='module'>
  toastr.options = {
    "closeButton": false,
    "positionClass": "toast-bottom-center",
    "preventDuplicates": true
  }



  // Get item information

  let params = new URLSearchParams(window.location.search);
  let itemID = params.get("itemID");

  if (!itemID) {
    toastr.error("There's no item ID to edit!", "Error");
  }

  let res = await fetch(`/api/listings/item/?item_id=${itemID}`);
  let info = {};
  if (res.status === 200) {
    info = await res.json();

  } else {
    let error = await res.text();
    toastr.error(error, "Error");
  }
  $("#itemName").val(info.info[0].name).change();
  $("#description").val(info.info[0].description).change();
  $("#price").val(info.info[0].price).change();

  // material handling

  let matIndex = 1;
  res = await fetch(`/api/inventory/`);
  let mats = {};
  if (res.status === 200) {
    mats = await res.json();
  } else {
    let error = await res.text();
    toastr.error(error, "Error");
  }

  for (let chosenMaterial of info.materials) {

    for (let x of [...Array(chosenMaterial.amount).keys()]) {
      let id = `material${matIndex}`;
      let matSelect = `<div id='${matIndex}' class='mt-2'><label class = 'me-2' for='materials[]'>Material Name:</label><select id='${id}' name='materials[]'> `;
      for (let mat of mats) {
        matSelect += `<option value='${mat.part_id}'>${mat.part_name}</option>`
      }
      matSelect += `</select><button type='button' class = 'mx-2 btn btn-danger delMatButton'>Delete Material</button></div>`
      let matHTML = $.parseHTML(matSelect);
      $("#materialsUsed").append(matHTML);
      $("#" + id).val(chosenMaterial.part_id).change();
      matIndex += 1;
    }

  }

  // metadata handling 
  let custIndex = 1;
  for (let metadata of info.metadata) {
    let custSelect = `<div id='${custIndex}' class='mt-2'><label class = 'me-2' for='metadata'>Customisation Name:</label><input name='metadata[]' value=${metadata.metadata_name} placeholder='Customisation name'><button type='button' class = 'mx-2 btn btn-danger delMetaButton'>Delete Customisation</button></div>`
    let custHTML = $.parseHTML(custSelect);
    $("#customisations").append(custHTML);
    custIndex += 1;
  }

  let delMatClickEvent = (e) => {
    let div = e.target.parentElement;
    let id = div.id;
    let deletedMatID = `#materialsUsed #${id}`;
    $(deletedMatID).remove();
  }

  $('.delMatButton').click(delMatClickEvent);

  let delMetaClickEvent = (e) => {
    let div = e.target.parentElement;
    let id = div.id;
    let deletedMetaID = `#customisations #${id}`;
    $(deletedMetaID).remove();
  }

  $('.delMetaButton').click(delMetaClickEvent);

  $("#addMatButton").click((e) => {
    matIndex += 1;
    let matSelect = `<div id = ${matIndex} class='mt-2'><label class = 'me-2' for='materials[]'>Material Name:</label><select name='materials[]'>`;
    for (let mat of mats) {
      matSelect += `<option value='${mat.part_id}'>${mat.part_name}</option>`
    }
    matSelect += `</select><button type='button' class = 'mx-2 btn btn-danger delMatButton'>Delete Material</button></div>`
    let matHTML = $.parseHTML(matSelect);
    $("#materialsUsed").append(matHTML);
    $('.delMatButton').click(delMatClickEvent);
  })

  $("#addCustButton").click(() => {
    custIndex += 1;
    let custSelect = `<div id = ${custIndex} class='mt-2'><label class = 'me-2' for='metadata'>Customisation Name:</label><input name='metadata[]' placeholder='Customisation name'><button class = 'mx-2 btn btn-danger delMetaButton'>Delete Customisation</button><div>`
    let custHTML = $.parseHTML(custSelect);
    $("#customisations").append(custHTML);
    $('.delMetaButton').click(delMetaClickEvent);
  })

  $('#updateListingForm').submit(async (e) => {
    e.preventDefault();
    const formData = new FormData(document.querySelector('#updateListingForm'));
    
    let res = await fetch("/api/listings/update/", {
        method: "POST",
        body: formData
    });
    if (res.status === 200) {
      let text = await res.text();
      console.log(text);
        // window.location = "/app/listings/"
    } else {
        let error = await res.text();
        toastr.error(error, "Error");
    }
    
  })

</script>